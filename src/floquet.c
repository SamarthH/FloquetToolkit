#include "floquet.h"

int floquet_get_stability_reals_general(int n, void (*A)(double, gsl_matrix*, void*), void* params, double T, gsl_complex* largest_multiplier, double* largest_multiplier_abs)
{
	gsl_matrix* X = gsl_matrix_alloc(n,n);
	gsl_matrix_set_identity(X);

	gsl_matrix* B = gsl_matrix_alloc(n,n);
	bulsto_final_matrix_floquet_type_real(X, 0., T, ERR_TOL, A, B, params);
	//rk4_adaptive_final_matrix_floquet_type_real(X, 0., T, ERR_TOL, A, B, params);

	gsl_vector_complex* eigenvals = gsl_vector_complex_alloc(n);

	gsl_eigen_nonsymm_workspace* w = gsl_eigen_nonsymm_alloc(n);

	int n_eigenvals_evaluated = n;
	
	int err_code = gsl_eigen_nonsymm(B,eigenvals,w);
	if(err_code)
	{
		n_eigenvals_evaluated = w->n_evals;
	}

	double mult_max_abs = -HUGE_VAL;
	gsl_complex mult_max;
	double ev_test;
	for (int i = 0; i < n_eigenvals_evaluated; ++i)
	{
		ev_test = gsl_complex_logabs(gsl_vector_complex_get(eigenvals,i));
		if (mult_max_abs < ev_test)
		{
			mult_max_abs = ev_test;
			mult_max = gsl_vector_complex_get(eigenvals,i);
		}
	}

	if (largest_multiplier != NULL)
	{
		*largest_multiplier = mult_max;
	}
	if (largest_multiplier_abs != NULL)
	{
		*largest_multiplier_abs = gsl_complex_abs(mult_max);
	}

	gsl_eigen_nonsymm_free(w);
	gsl_vector_complex_free(eigenvals);
	gsl_matrix_free(B);
	gsl_matrix_free(X);

	if (mult_max_abs > ERR_EIGEN_TOL)
	{
		return 1;
	}
	else if (mult_max_abs < (-ERR_EIGEN_TOL))
	{
		if (n_eigenvals_evaluated < n)
		{
			return 2;
		}
		return -1;
	}
	else
	{
		return 0;
	}
}

void floquet_get_stability_array_real_single_param_general(int n, void (*A)(double, gsl_matrix*, void*), double T, double start, double end, int nstep, int* stability, gsl_complex* largest_multiplier, double* largest_multiplier_abs)
{
	gsl_complex* mult_temp;
	double* mult_abs_temp;

	if (largest_multiplier)
	{
		mult_temp = largest_multiplier;
	}
	else
	{
		mult_temp = (gsl_complex*) malloc(nstep*sizeof(gsl_complex));
	}

	if (largest_multiplier_abs)
	{
		mult_abs_temp = largest_multiplier_abs;
	}
	else
	{
		mult_abs_temp = (double*) malloc(nstep*sizeof(double));
	}

	double step = (end-start)/(nstep-1);
	#pragma omp parallel for
	for (int i = 0; i < nstep; ++i)
	{
		double param = start + step*i;
		stability[i] = floquet_get_stability_reals_general(n,A,&param,T,mult_temp+i,mult_abs_temp+i);
	}

	if(!largest_multiplier)
	{
		free(mult_temp);
	}
	if(!largest_multiplier_abs)
	{
		free(mult_abs_temp);
	}
}

void floquet_get_stability_array_real_double_param_general(int n, void (*A)(double, gsl_matrix*, void*), double T, double* start, double* end, int* nstep, int** stability, gsl_complex** largest_multiplier, double** largest_multiplier_abs)
{
	gsl_complex** mult_temp;
	double** mult_abs_temp;

	if (largest_multiplier)
	{
		mult_temp = largest_multiplier;
	}
	else
	{
		mult_temp = (gsl_complex**) malloc(nstep[0]*sizeof(gsl_complex*));
		for (int i = 0; i < nstep[0]; ++i)
		{
			mult_temp[i] = (gsl_complex*) malloc(nstep[1]*sizeof(gsl_complex));
		}
	}

	if (largest_multiplier_abs)
	{
		mult_abs_temp = largest_multiplier_abs;
	}
	else
	{
		mult_abs_temp = (double**) malloc(nstep[0]*sizeof(double*));
		for (int i = 0; i < nstep[0]; ++i)
		{
			mult_abs_temp[i] = (double*) malloc(nstep[1]*sizeof(double));
		}
	}

	double step[2] = {(end[0]-start[0])/(nstep[0]-1), (end[1]-start[1])/(nstep[1]-1)};
	#pragma omp parallel for collapse(2) schedule(guided)
	for (int i = 0; i < nstep[0]; ++i)
	{
		for (int j = 0; j < nstep[1]; ++j)
		{
			double param[2] = {start[0] + step[0]*i, start[1] + step[1]*j };
			stability[i][j] = floquet_get_stability_reals_general(n,A,param,T,&mult_temp[i][j],&mult_abs_temp[i][j]);
		}
	}

	if(!largest_multiplier)
	{
		for (int i = 0; i < nstep[0]; ++i)
		{
			free(mult_temp[i]);
		}
		free(mult_temp);
	}

	if(!largest_multiplier_abs)
	{
		for (int i = 0; i < nstep[0]; ++i)
		{
			free(mult_abs_temp[i]);
		}
		free(mult_abs_temp);
	}
}

int floquet_get_stability_reals_goodfunc(int n, void (*A)(double, gsl_matrix*, void*), void* params, double T, gsl_complex* largest_multiplier, double* largest_multiplier_abs)
{
	int N = 1000;
	double gauss_x[1000] = {0.99999711,0.99998478,0.99996259,0.99993055,0.99988865,0.99983689,0.99977527,0.99970379,0.99962246,0.99953127,0.99943022,0.99931932,0.99919857,0.99906797,0.99892751,0.99877721,0.99861706,0.99844706,0.99826722,0.99807753,0.99787801,0.99766864,0.99744944,0.99722041,0.99698154,0.99673284,0.99647432,0.99620597,0.9959278,0.9956398,0.99534199,0.99503437,0.99471694,0.9943897,0.99405265,0.99370581,0.99334916,0.99298272,0.99260649,0.99222048,0.99182468,0.9914191,0.99100375,0.99057863,0.99014373,0.98969908,0.98924467,0.9887805,0.98830659,0.98782293,0.98732953,0.9868264,0.98631354,0.98579095,0.98525864,0.98471662,0.98416489,0.98360345,0.98303232,0.9824515,0.98186098,0.98126079,0.98065092,0.98003139,0.97940219,0.97876333,0.97811482,0.97745667,0.97678889,0.97611147,0.97542442,0.97472776,0.97402149,0.97330562,0.97258015,0.97184509,0.97110044,0.97034623,0.96958244,0.9688091,0.9680262,0.96723376,0.96643178,0.96562027,0.96479925,0.96396871,0.96312866,0.96227912,0.96142009,0.96055159,0.95967361,0.95878617,0.95788927,0.95698293,0.95606716,0.95514196,0.95420734,0.95326331,0.95230989,0.95134707,0.95037488,0.94939331,0.94840238,0.94740211,0.94639249,0.94537354,0.94434527,0.94330769,0.9422608,0.94120463,0.94013918,0.93906446,0.93798047,0.93688725,0.93578478,0.93467308,0.93355217,0.93242206,0.93128275,0.93013426,0.9289766,0.92780978,0.92663382,0.92544871,0.92425448,0.92305114,0.9218387,0.92061717,0.91938656,0.91814688,0.91689816,0.91564039,0.9143736,0.91309779,0.91181297,0.91051917,0.90921639,0.90790464,0.90658394,0.90525431,0.90391575,0.90256827,0.9012119,0.89984664,0.89847251,0.89708952,0.89569769,0.89429702,0.89288754,0.89146925,0.89004217,0.88860632,0.88716171,0.88570835,0.88424625,0.88277544,0.88129592,0.87980772,0.87831084,0.8768053,0.87529111,0.8737683,0.87223687,0.87069684,0.86914822,0.86759103,0.8660253,0.86445102,0.86286822,0.86127691,0.85967711,0.85806883,0.85645209,0.85482691,0.8531933,0.85155128,0.84990086,0.84824206,0.8465749,0.84489939,0.84321555,0.8415234,0.83982295,0.83811422,0.83639722,0.83467198,0.83293851,0.83119683,0.82944695,0.82768889,0.82592268,0.82414832,0.82236583,0.82057524,0.81877655,0.81696979,0.81515498,0.81333213,0.81150126,0.80966239,0.80781553,0.80596071,0.80409795,0.80222725,0.80034865,0.79846215,0.79656779,0.79466556,0.79275551,0.79083763,0.78891196,0.78697852,0.78503731,0.78308836,0.78113169,0.77916732,0.77719526,0.77521555,0.77322819,0.7712332,0.76923062,0.76722044,0.76520271,0.76317742,0.76114462,0.75910431,0.75705651,0.75500125,0.75293855,0.75086842,0.74879089,0.74670597,0.7446137,0.74251408,0.74040714,0.7382929,0.73617138,0.7340426,0.73190659,0.72976336,0.72761293,0.72545533,0.72329058,0.72111869,0.7189397,0.71675361,0.71456046,0.71236027,0.71015305,0.70793883,0.70571763,0.70348947,0.70125437,0.69901236,0.69676346,0.69450769,0.69224507,0.68997562,0.68769937,0.68541634,0.68312656,0.68083004,0.6785268,0.67621688,0.67390028,0.67157705,0.66924719,0.66691073,0.6645677,0.66221811,0.659862,0.65749938,0.65513028,0.65275472,0.65037272,0.64798431,0.64558951,0.64318834,0.64078083,0.63836701,0.63594689,0.6335205,0.63108787,0.62864901,0.62620395,0.62375272,0.62129534,0.61883183,0.61636223,0.61388654,0.6114048,0.60891704,0.60642327,0.60392352,0.60141782,0.59890618,0.59638864,0.59386523,0.59133595,0.58880085,0.58625994,0.58371325,0.5811608,0.57860263,0.57603875,0.57346919,0.57089397,0.56831313,0.56572668,0.56313466,0.56053708,0.55793398,0.55532537,0.55271129,0.55009176,0.54746681,0.54483646,0.54220074,0.53955967,0.53691328,0.5342616,0.53160465,0.52894245,0.52627505,0.52360245,0.52092469,0.5182418,0.51555379,0.51286071,0.51016256,0.50745939,0.50475121,0.50203805,0.49931995,0.49659692,0.493869,0.4911362,0.48839857,0.48565612,0.48290888,0.48015687,0.47740014,0.4746387,0.47187257,0.4691018,0.4663264,0.4635464,0.46076183,0.45797272,0.4551791,0.45238098,0.44957841,0.4467714,0.44395998,0.44114419,0.43832405,0.43549959,0.43267084,0.42983782,0.42700056,0.42415909,0.42131343,0.41846363,0.4156097,0.41275167,0.40988957,0.40702343,0.40415327,0.40127914,0.39840104,0.39551902,0.39263309,0.3897433,0.38684966,0.38395221,0.38105097,0.37814598,0.37523726,0.37232484,0.36940874,0.36648901,0.36356566,0.36063873,0.35770824,0.35477422,0.35183671,0.34889572,0.3459513,0.34300347,0.34005225,0.33709768,0.33413979,0.3311786,0.32821415,0.32524646,0.32227556,0.31930149,0.31632427,0.31334393,0.3103605,0.30737401,0.30438449,0.30139197,0.29839647,0.29539804,0.29239669,0.28939246,0.28638538,0.28337547,0.28036277,0.2773473,0.2743291,0.2713082,0.26828461,0.26525839,0.26222955,0.25919812,0.25616414,0.25312763,0.25008863,0.24704716,0.24400325,0.24095694,0.23790825,0.23485722,0.23180387,0.22874824,0.22569035,0.22263024,0.21956793,0.21650345,0.21343684,0.21036813,0.20729734,0.20422451,0.20114967,0.19807284,0.19499406,0.19191335,0.18883076,0.1857463,0.18266001,0.17957192,0.17648206,0.17339046,0.17029715,0.16720216,0.16410552,0.16100726,0.15790742,0.15480602,0.15170309,0.14859867,0.14549278,0.14238546,0.13927673,0.13616663,0.13305519,0.12994244,0.1268284,0.12371312,0.12059661,0.11747892,0.11436006,0.11124008,0.108119,0.10499686,0.10187368,0.0987495,0.09562434,0.09249824,0.08937123,0.08624334,0.0831146,0.07998504,0.07685468,0.07372358,0.07059174,0.06745921,0.06432601,0.06119218,0.05805775,0.05492274,0.05178719,0.04865113,0.04551459,0.04237761,0.0392402,0.03610241,0.03296426,0.02982579,0.02668702,0.02354799,0.02040873,0.01726926,0.01412963,0.01098986,0.00784998,0.00471002,0.00157001,-0.00157001,-0.00471002,-0.00784998,-0.01098986,-0.01412963,-0.01726926,-0.02040873,-0.02354799,-0.02668702,-0.02982579,-0.03296426,-0.03610241,-0.0392402,-0.04237761,-0.04551459,-0.04865113,-0.05178719,-0.05492274,-0.05805775,-0.06119218,-0.06432601,-0.06745921,-0.07059174,-0.07372358,-0.07685468,-0.07998504,-0.0831146,-0.08624334,-0.08937123,-0.09249824,-0.09562434,-0.0987495,-0.10187368,-0.10499686,-0.108119,-0.11124008,-0.11436006,-0.11747892,-0.12059661,-0.12371312,-0.1268284,-0.12994244,-0.13305519,-0.13616663,-0.13927673,-0.14238546,-0.14549278,-0.14859867,-0.15170309,-0.15480602,-0.15790742,-0.16100726,-0.16410552,-0.16720216,-0.17029715,-0.17339046,-0.17648206,-0.17957192,-0.18266001,-0.1857463,-0.18883076,-0.19191335,-0.19499406,-0.19807284,-0.20114967,-0.20422451,-0.20729734,-0.21036813,-0.21343684,-0.21650345,-0.21956793,-0.22263024,-0.22569035,-0.22874824,-0.23180387,-0.23485722,-0.23790825,-0.24095694,-0.24400325,-0.24704716,-0.25008863,-0.25312763,-0.25616414,-0.25919812,-0.26222955,-0.26525839,-0.26828461,-0.2713082,-0.2743291,-0.2773473,-0.28036277,-0.28337547,-0.28638538,-0.28939246,-0.29239669,-0.29539804,-0.29839647,-0.30139197,-0.30438449,-0.30737401,-0.3103605,-0.31334393,-0.31632427,-0.31930149,-0.32227556,-0.32524646,-0.32821415,-0.3311786,-0.33413979,-0.33709768,-0.34005225,-0.34300347,-0.3459513,-0.34889572,-0.35183671,-0.35477422,-0.35770824,-0.36063873,-0.36356566,-0.36648901,-0.36940874,-0.37232484,-0.37523726,-0.37814598,-0.38105097,-0.38395221,-0.38684966,-0.3897433,-0.39263309,-0.39551902,-0.39840104,-0.40127914,-0.40415327,-0.40702343,-0.40988957,-0.41275167,-0.4156097,-0.41846363,-0.42131343,-0.42415909,-0.42700056,-0.42983782,-0.43267084,-0.43549959,-0.43832405,-0.44114419,-0.44395998,-0.4467714,-0.44957841,-0.45238098,-0.4551791,-0.45797272,-0.46076183,-0.4635464,-0.4663264,-0.4691018,-0.47187257,-0.4746387,-0.47740014,-0.48015687,-0.48290888,-0.48565612,-0.48839857,-0.4911362,-0.493869,-0.49659692,-0.49931995,-0.50203805,-0.50475121,-0.50745939,-0.51016256,-0.51286071,-0.51555379,-0.5182418,-0.52092469,-0.52360245,-0.52627505,-0.52894245,-0.53160465,-0.5342616,-0.53691328,-0.53955967,-0.54220074,-0.54483646,-0.54746681,-0.55009176,-0.55271129,-0.55532537,-0.55793398,-0.56053708,-0.56313466,-0.56572668,-0.56831313,-0.57089397,-0.57346919,-0.57603875,-0.57860263,-0.5811608,-0.58371325,-0.58625994,-0.58880085,-0.59133595,-0.59386523,-0.59638864,-0.59890618,-0.60141782,-0.60392352,-0.60642327,-0.60891704,-0.6114048,-0.61388654,-0.61636223,-0.61883183,-0.62129534,-0.62375272,-0.62620395,-0.62864901,-0.63108787,-0.6335205,-0.63594689,-0.63836701,-0.64078083,-0.64318834,-0.64558951,-0.64798431,-0.65037272,-0.65275472,-0.65513028,-0.65749938,-0.659862,-0.66221811,-0.6645677,-0.66691073,-0.66924719,-0.67157705,-0.67390028,-0.67621688,-0.6785268,-0.68083004,-0.68312656,-0.68541634,-0.68769937,-0.68997562,-0.69224507,-0.69450769,-0.69676346,-0.69901236,-0.70125437,-0.70348947,-0.70571763,-0.70793883,-0.71015305,-0.71236027,-0.71456046,-0.71675361,-0.7189397,-0.72111869,-0.72329058,-0.72545533,-0.72761293,-0.72976336,-0.73190659,-0.7340426,-0.73617138,-0.7382929,-0.74040714,-0.74251408,-0.7446137,-0.74670597,-0.74879089,-0.75086842,-0.75293855,-0.75500125,-0.75705651,-0.75910431,-0.76114462,-0.76317742,-0.76520271,-0.76722044,-0.76923062,-0.7712332,-0.77322819,-0.77521555,-0.77719526,-0.77916732,-0.78113169,-0.78308836,-0.78503731,-0.78697852,-0.78891196,-0.79083763,-0.79275551,-0.79466556,-0.79656779,-0.79846215,-0.80034865,-0.80222725,-0.80409795,-0.80596071,-0.80781553,-0.80966239,-0.81150126,-0.81333213,-0.81515498,-0.81696979,-0.81877655,-0.82057524,-0.82236583,-0.82414832,-0.82592268,-0.82768889,-0.82944695,-0.83119683,-0.83293851,-0.83467198,-0.83639722,-0.83811422,-0.83982295,-0.8415234,-0.84321555,-0.84489939,-0.8465749,-0.84824206,-0.84990086,-0.85155128,-0.8531933,-0.85482691,-0.85645209,-0.85806883,-0.85967711,-0.86127691,-0.86286822,-0.86445102,-0.8660253,-0.86759103,-0.86914822,-0.87069684,-0.87223687,-0.8737683,-0.87529111,-0.8768053,-0.87831084,-0.87980772,-0.88129592,-0.88277544,-0.88424625,-0.88570835,-0.88716171,-0.88860632,-0.89004217,-0.89146925,-0.89288754,-0.89429702,-0.89569769,-0.89708952,-0.89847251,-0.89984664,-0.9012119,-0.90256827,-0.90391575,-0.90525431,-0.90658394,-0.90790464,-0.90921639,-0.91051917,-0.91181297,-0.91309779,-0.9143736,-0.91564039,-0.91689816,-0.91814688,-0.91938656,-0.92061717,-0.9218387,-0.92305114,-0.92425448,-0.92544871,-0.92663382,-0.92780978,-0.9289766,-0.93013426,-0.93128275,-0.93242206,-0.93355217,-0.93467308,-0.93578478,-0.93688725,-0.93798047,-0.93906446,-0.94013918,-0.94120463,-0.9422608,-0.94330769,-0.94434527,-0.94537354,-0.94639249,-0.94740211,-0.94840238,-0.94939331,-0.95037488,-0.95134707,-0.95230989,-0.95326331,-0.95420734,-0.95514196,-0.95606716,-0.95698293,-0.95788927,-0.95878617,-0.95967361,-0.96055159,-0.96142009,-0.96227912,-0.96312866,-0.96396871,-0.96479925,-0.96562027,-0.96643178,-0.96723376,-0.9680262,-0.9688091,-0.96958244,-0.97034623,-0.97110044,-0.97184509,-0.97258015,-0.97330562,-0.97402149,-0.97472776,-0.97542442,-0.97611147,-0.97678889,-0.97745667,-0.97811482,-0.97876333,-0.97940219,-0.98003139,-0.98065092,-0.98126079,-0.98186098,-0.9824515,-0.98303232,-0.98360345,-0.98416489,-0.98471662,-0.98525864,-0.98579095,-0.98631354,-0.9868264,-0.98732953,-0.98782293,-0.98830659,-0.9887805,-0.98924467,-0.98969908,-0.99014373,-0.99057863,-0.99100375,-0.9914191,-0.99182468,-0.99222048,-0.99260649,-0.99298272,-0.99334916,-0.99370581,-0.99405265,-0.9943897,-0.99471694,-0.99503437,-0.99534199,-0.9956398,-0.9959278,-0.99620597,-0.99647432,-0.99673284,-0.99698154,-0.99722041,-0.99744944,-0.99766864,-0.99787801,-0.99807753,-0.99826722,-0.99844706,-0.99861706,-0.99877721,-0.99892751,-0.99906797,-0.99919857,-0.99931932,-0.99943022,-0.99953127,-0.99962246,-0.99970379,-0.99977527,-0.99983689,-0.99988865,-0.99993055,-0.99996259,-0.99998478,-0.99999711};
	double gauss_w[1000] = {7.41333842e-06,1.72567698e-05,2.71146066e-05,3.69734420e-05,4.68321671e-05,5.66905065e-05,6.65483159e-05,7.64054821e-05,8.62619013e-05,9.61174735e-05,1.05972100e-04,1.15825683e-04,1.25678125e-04,1.35529328e-04,1.45379195e-04,1.55227629e-04,1.65074533e-04,1.74919809e-04,1.84763361e-04,1.94605091e-04,2.04444902e-04,2.14282698e-04,2.24118381e-04,2.33951854e-04,2.43783020e-04,2.53611783e-04,2.63438046e-04,2.73261711e-04,2.83082681e-04,2.92900861e-04,3.02716152e-04,3.12528459e-04,3.22337685e-04,3.32143732e-04,3.41946505e-04,3.51745906e-04,3.61541839e-04,3.71334207e-04,3.81122914e-04,3.90907863e-04,4.00688958e-04,4.10466102e-04,4.20239199e-04,4.30008153e-04,4.39772867e-04,4.49533245e-04,4.59289190e-04,4.69040607e-04,4.78787400e-04,4.88529472e-04,4.98266727e-04,5.07999069e-04,5.17726402e-04,5.27448631e-04,5.37165660e-04,5.46877392e-04,5.56583732e-04,5.66284584e-04,5.75979853e-04,5.85669443e-04,5.95353258e-04,6.05031203e-04,6.14703183e-04,6.24369102e-04,6.34028865e-04,6.43682376e-04,6.53329541e-04,6.62970265e-04,6.72604451e-04,6.82232006e-04,6.91852834e-04,7.01466841e-04,7.11073932e-04,7.20674011e-04,7.30266985e-04,7.39852759e-04,7.49431238e-04,7.59002327e-04,7.68565934e-04,7.78121962e-04,7.87670318e-04,7.97210908e-04,8.06743638e-04,8.16268413e-04,8.25785140e-04,8.35293726e-04,8.44794075e-04,8.54286095e-04,8.63769692e-04,8.73244772e-04,8.82711243e-04,8.92169010e-04,9.01617980e-04,9.11058061e-04,9.20489159e-04,9.29911182e-04,9.39324035e-04,9.48727628e-04,9.58121866e-04,9.67506657e-04,9.76881908e-04,9.86247528e-04,9.95603424e-04,1.00494950e-03,1.01428567e-03,1.02361184e-03,1.03292792e-03,1.04223382e-03,1.05152943e-03,1.06081468e-03,1.07008947e-03,1.07935371e-03,1.08860731e-03,1.09785017e-03,1.10708221e-03,1.11630334e-03,1.12551345e-03,1.13471247e-03,1.14390031e-03,1.15307686e-03,1.16224204e-03,1.17139577e-03,1.18053794e-03,1.18966848e-03,1.19878729e-03,1.20789427e-03,1.21698935e-03,1.22607243e-03,1.23514341e-03,1.24420222e-03,1.25324877e-03,1.26228295e-03,1.27130469e-03,1.28031390e-03,1.28931048e-03,1.29829435e-03,1.30726542e-03,1.31622360e-03,1.32516880e-03,1.33410094e-03,1.34301992e-03,1.35192566e-03,1.36081807e-03,1.36969707e-03,1.37856256e-03,1.38741445e-03,1.39625267e-03,1.40507712e-03,1.41388772e-03,1.42268437e-03,1.43146700e-03,1.44023552e-03,1.44898983e-03,1.45772986e-03,1.46645552e-03,1.47516671e-03,1.48386336e-03,1.49254538e-03,1.50121269e-03,1.50986519e-03,1.51850281e-03,1.52712545e-03,1.53573304e-03,1.54432549e-03,1.55290271e-03,1.56146461e-03,1.57001113e-03,1.57854216e-03,1.58705763e-03,1.59555745e-03,1.60404153e-03,1.61250981e-03,1.62096218e-03,1.62939857e-03,1.63781890e-03,1.64622308e-03,1.65461102e-03,1.66298266e-03,1.67133789e-03,1.67967665e-03,1.68799885e-03,1.69630440e-03,1.70459323e-03,1.71286525e-03,1.72112038e-03,1.72935854e-03,1.73757965e-03,1.74578363e-03,1.75397040e-03,1.76213987e-03,1.77029197e-03,1.77842661e-03,1.78654372e-03,1.79464322e-03,1.80272502e-03,1.81078904e-03,1.81883521e-03,1.82686345e-03,1.83487368e-03,1.84286581e-03,1.85083978e-03,1.85879549e-03,1.86673288e-03,1.87465186e-03,1.88255236e-03,1.89043430e-03,1.89829760e-03,1.90614218e-03,1.91396797e-03,1.92177488e-03,1.92956285e-03,1.93733180e-03,1.94508164e-03,1.95281230e-03,1.96052371e-03,1.96821579e-03,1.97588846e-03,1.98354165e-03,1.99117529e-03,1.99878929e-03,2.00638358e-03,2.01395810e-03,2.02151275e-03,2.02904747e-03,2.03656219e-03,2.04405683e-03,2.05153131e-03,2.05898557e-03,2.06641952e-03,2.07383310e-03,2.08122624e-03,2.08859885e-03,2.09595087e-03,2.10328222e-03,2.11059284e-03,2.11788265e-03,2.12515157e-03,2.13239954e-03,2.13962649e-03,2.14683234e-03,2.15401702e-03,2.16118047e-03,2.16832261e-03,2.17544336e-03,2.18254267e-03,2.18962046e-03,2.19667666e-03,2.20371120e-03,2.21072401e-03,2.21771503e-03,2.22468418e-03,2.23163139e-03,2.23855661e-03,2.24545975e-03,2.25234075e-03,2.25919954e-03,2.26603606e-03,2.27285023e-03,2.27964200e-03,2.28641129e-03,2.29315803e-03,2.29988217e-03,2.30658363e-03,2.31326235e-03,2.31991825e-03,2.32655129e-03,2.33316139e-03,2.33974848e-03,2.34631250e-03,2.35285339e-03,2.35937108e-03,2.36586551e-03,2.37233661e-03,2.37878432e-03,2.38520857e-03,2.39160931e-03,2.39798647e-03,2.40433998e-03,2.41066979e-03,2.41697583e-03,2.42325804e-03,2.42951635e-03,2.43575071e-03,2.44196106e-03,2.44814733e-03,2.45430946e-03,2.46044739e-03,2.46656106e-03,2.47265041e-03,2.47871539e-03,2.48475592e-03,2.49077195e-03,2.49676343e-03,2.50273029e-03,2.50867247e-03,2.51458992e-03,2.52048257e-03,2.52635037e-03,2.53219327e-03,2.53801120e-03,2.54380410e-03,2.54957192e-03,2.55531460e-03,2.56103209e-03,2.56672433e-03,2.57239126e-03,2.57803283e-03,2.58364898e-03,2.58923965e-03,2.59480480e-03,2.60034436e-03,2.60585828e-03,2.61134651e-03,2.61680899e-03,2.62224568e-03,2.62765650e-03,2.63304142e-03,2.63840038e-03,2.64373332e-03,2.64904020e-03,2.65432096e-03,2.65957555e-03,2.66480391e-03,2.67000600e-03,2.67518177e-03,2.68033115e-03,2.68545412e-03,2.69055060e-03,2.69562055e-03,2.70066393e-03,2.70568068e-03,2.71067075e-03,2.71563410e-03,2.72057067e-03,2.72548041e-03,2.73036329e-03,2.73521924e-03,2.74004822e-03,2.74485019e-03,2.74962510e-03,2.75437289e-03,2.75909353e-03,2.76378696e-03,2.76845314e-03,2.77309203e-03,2.77770357e-03,2.78228773e-03,2.78684445e-03,2.79137370e-03,2.79587542e-03,2.80034958e-03,2.80479613e-03,2.80921502e-03,2.81360622e-03,2.81796967e-03,2.82230534e-03,2.82661318e-03,2.83089315e-03,2.83514521e-03,2.83936932e-03,2.84356543e-03,2.84773350e-03,2.85187350e-03,2.85598537e-03,2.86006909e-03,2.86412461e-03,2.86815189e-03,2.87215089e-03,2.87612157e-03,2.88006389e-03,2.88397782e-03,2.88786331e-03,2.89172033e-03,2.89554884e-03,2.89934879e-03,2.90312016e-03,2.90686291e-03,2.91057700e-03,2.91426238e-03,2.91791904e-03,2.92154692e-03,2.92514600e-03,2.92871624e-03,2.93225760e-03,2.93577005e-03,2.93925355e-03,2.94270807e-03,2.94613358e-03,2.94953004e-03,2.95289742e-03,2.95623569e-03,2.95954481e-03,2.96282474e-03,2.96607547e-03,2.96929695e-03,2.97248915e-03,2.97565204e-03,2.97878560e-03,2.98188978e-03,2.98496457e-03,2.98800992e-03,2.99102582e-03,2.99401222e-03,2.99696910e-03,2.99989643e-03,3.00279419e-03,3.00566234e-03,3.00850085e-03,3.01130970e-03,3.01408886e-03,3.01683830e-03,3.01955799e-03,3.02224792e-03,3.02490804e-03,3.02753834e-03,3.03013879e-03,3.03270937e-03,3.03525004e-03,3.03776078e-03,3.04024158e-03,3.04269239e-03,3.04511321e-03,3.04750400e-03,3.04986475e-03,3.05219542e-03,3.05449601e-03,3.05676647e-03,3.05900680e-03,3.06121696e-03,3.06339694e-03,3.06554672e-03,3.06766627e-03,3.06975558e-03,3.07181462e-03,3.07384337e-03,3.07584181e-03,3.07780993e-03,3.07974770e-03,3.08165510e-03,3.08353213e-03,3.08537874e-03,3.08719494e-03,3.08898070e-03,3.09073600e-03,3.09246083e-03,3.09415516e-03,3.09581899e-03,3.09745230e-03,3.09905507e-03,3.10062727e-03,3.10216891e-03,3.10367996e-03,3.10516041e-03,3.10661025e-03,3.10802945e-03,3.10941801e-03,3.11077591e-03,3.11210314e-03,3.11339969e-03,3.11466554e-03,3.11590068e-03,3.11710509e-03,3.11827877e-03,3.11942171e-03,3.12053389e-03,3.12161531e-03,3.12266594e-03,3.12368579e-03,3.12467483e-03,3.12563307e-03,3.12656049e-03,3.12745709e-03,3.12832284e-03,3.12915776e-03,3.12996182e-03,3.13073502e-03,3.13147735e-03,3.13218881e-03,3.13286938e-03,3.13351907e-03,3.13413786e-03,3.13472574e-03,3.13528272e-03,3.13580879e-03,3.13630394e-03,3.13676816e-03,3.13720146e-03,3.13760383e-03,3.13797526e-03,3.13831575e-03,3.13862529e-03,3.13890389e-03,3.13915155e-03,3.13936825e-03,3.13955399e-03,3.13970879e-03,3.13983262e-03,3.13992550e-03,3.13998742e-03,3.14001838e-03,3.14001838e-03,3.13998742e-03,3.13992550e-03,3.13983262e-03,3.13970879e-03,3.13955399e-03,3.13936825e-03,3.13915155e-03,3.13890389e-03,3.13862529e-03,3.13831575e-03,3.13797526e-03,3.13760383e-03,3.13720146e-03,3.13676816e-03,3.13630394e-03,3.13580879e-03,3.13528272e-03,3.13472574e-03,3.13413786e-03,3.13351907e-03,3.13286938e-03,3.13218881e-03,3.13147735e-03,3.13073502e-03,3.12996182e-03,3.12915776e-03,3.12832284e-03,3.12745709e-03,3.12656049e-03,3.12563307e-03,3.12467483e-03,3.12368579e-03,3.12266594e-03,3.12161531e-03,3.12053389e-03,3.11942171e-03,3.11827877e-03,3.11710509e-03,3.11590068e-03,3.11466554e-03,3.11339969e-03,3.11210314e-03,3.11077591e-03,3.10941801e-03,3.10802945e-03,3.10661025e-03,3.10516041e-03,3.10367996e-03,3.10216891e-03,3.10062727e-03,3.09905507e-03,3.09745230e-03,3.09581899e-03,3.09415516e-03,3.09246083e-03,3.09073600e-03,3.08898070e-03,3.08719494e-03,3.08537874e-03,3.08353213e-03,3.08165510e-03,3.07974770e-03,3.07780993e-03,3.07584181e-03,3.07384337e-03,3.07181462e-03,3.06975558e-03,3.06766627e-03,3.06554672e-03,3.06339694e-03,3.06121696e-03,3.05900680e-03,3.05676647e-03,3.05449601e-03,3.05219542e-03,3.04986475e-03,3.04750400e-03,3.04511321e-03,3.04269239e-03,3.04024158e-03,3.03776078e-03,3.03525004e-03,3.03270937e-03,3.03013879e-03,3.02753834e-03,3.02490804e-03,3.02224792e-03,3.01955799e-03,3.01683830e-03,3.01408886e-03,3.01130970e-03,3.00850085e-03,3.00566234e-03,3.00279419e-03,2.99989643e-03,2.99696910e-03,2.99401222e-03,2.99102582e-03,2.98800992e-03,2.98496457e-03,2.98188978e-03,2.97878560e-03,2.97565204e-03,2.97248915e-03,2.96929695e-03,2.96607547e-03,2.96282474e-03,2.95954481e-03,2.95623569e-03,2.95289742e-03,2.94953004e-03,2.94613358e-03,2.94270807e-03,2.93925355e-03,2.93577005e-03,2.93225760e-03,2.92871624e-03,2.92514600e-03,2.92154692e-03,2.91791904e-03,2.91426238e-03,2.91057700e-03,2.90686291e-03,2.90312016e-03,2.89934879e-03,2.89554884e-03,2.89172033e-03,2.88786331e-03,2.88397782e-03,2.88006389e-03,2.87612157e-03,2.87215089e-03,2.86815189e-03,2.86412461e-03,2.86006909e-03,2.85598537e-03,2.85187350e-03,2.84773350e-03,2.84356543e-03,2.83936932e-03,2.83514521e-03,2.83089315e-03,2.82661318e-03,2.82230534e-03,2.81796967e-03,2.81360622e-03,2.80921502e-03,2.80479613e-03,2.80034958e-03,2.79587542e-03,2.79137370e-03,2.78684445e-03,2.78228773e-03,2.77770357e-03,2.77309203e-03,2.76845314e-03,2.76378696e-03,2.75909353e-03,2.75437289e-03,2.74962510e-03,2.74485019e-03,2.74004822e-03,2.73521924e-03,2.73036329e-03,2.72548041e-03,2.72057067e-03,2.71563410e-03,2.71067075e-03,2.70568068e-03,2.70066393e-03,2.69562055e-03,2.69055060e-03,2.68545412e-03,2.68033115e-03,2.67518177e-03,2.67000600e-03,2.66480391e-03,2.65957555e-03,2.65432096e-03,2.64904020e-03,2.64373332e-03,2.63840038e-03,2.63304142e-03,2.62765650e-03,2.62224568e-03,2.61680899e-03,2.61134651e-03,2.60585828e-03,2.60034436e-03,2.59480480e-03,2.58923965e-03,2.58364898e-03,2.57803283e-03,2.57239126e-03,2.56672433e-03,2.56103209e-03,2.55531460e-03,2.54957192e-03,2.54380410e-03,2.53801120e-03,2.53219327e-03,2.52635037e-03,2.52048257e-03,2.51458992e-03,2.50867247e-03,2.50273029e-03,2.49676343e-03,2.49077195e-03,2.48475592e-03,2.47871539e-03,2.47265041e-03,2.46656106e-03,2.46044739e-03,2.45430946e-03,2.44814733e-03,2.44196106e-03,2.43575071e-03,2.42951635e-03,2.42325804e-03,2.41697583e-03,2.41066979e-03,2.40433998e-03,2.39798647e-03,2.39160931e-03,2.38520857e-03,2.37878432e-03,2.37233661e-03,2.36586551e-03,2.35937108e-03,2.35285339e-03,2.34631250e-03,2.33974848e-03,2.33316139e-03,2.32655129e-03,2.31991825e-03,2.31326235e-03,2.30658363e-03,2.29988217e-03,2.29315803e-03,2.28641129e-03,2.27964200e-03,2.27285023e-03,2.26603606e-03,2.25919954e-03,2.25234075e-03,2.24545975e-03,2.23855661e-03,2.23163139e-03,2.22468418e-03,2.21771503e-03,2.21072401e-03,2.20371120e-03,2.19667666e-03,2.18962046e-03,2.18254267e-03,2.17544336e-03,2.16832261e-03,2.16118047e-03,2.15401702e-03,2.14683234e-03,2.13962649e-03,2.13239954e-03,2.12515157e-03,2.11788265e-03,2.11059284e-03,2.10328222e-03,2.09595087e-03,2.08859885e-03,2.08122624e-03,2.07383310e-03,2.06641952e-03,2.05898557e-03,2.05153131e-03,2.04405683e-03,2.03656219e-03,2.02904747e-03,2.02151275e-03,2.01395810e-03,2.00638358e-03,1.99878929e-03,1.99117529e-03,1.98354165e-03,1.97588846e-03,1.96821579e-03,1.96052371e-03,1.95281230e-03,1.94508164e-03,1.93733180e-03,1.92956285e-03,1.92177488e-03,1.91396797e-03,1.90614218e-03,1.89829760e-03,1.89043430e-03,1.88255236e-03,1.87465186e-03,1.86673288e-03,1.85879549e-03,1.85083978e-03,1.84286581e-03,1.83487368e-03,1.82686345e-03,1.81883521e-03,1.81078904e-03,1.80272502e-03,1.79464322e-03,1.78654372e-03,1.77842661e-03,1.77029197e-03,1.76213987e-03,1.75397040e-03,1.74578363e-03,1.73757965e-03,1.72935854e-03,1.72112038e-03,1.71286525e-03,1.70459323e-03,1.69630440e-03,1.68799885e-03,1.67967665e-03,1.67133789e-03,1.66298266e-03,1.65461102e-03,1.64622308e-03,1.63781890e-03,1.62939857e-03,1.62096218e-03,1.61250981e-03,1.60404153e-03,1.59555745e-03,1.58705763e-03,1.57854216e-03,1.57001113e-03,1.56146461e-03,1.55290271e-03,1.54432549e-03,1.53573304e-03,1.52712545e-03,1.51850281e-03,1.50986519e-03,1.50121269e-03,1.49254538e-03,1.48386336e-03,1.47516671e-03,1.46645552e-03,1.45772986e-03,1.44898983e-03,1.44023552e-03,1.43146700e-03,1.42268437e-03,1.41388772e-03,1.40507712e-03,1.39625267e-03,1.38741445e-03,1.37856256e-03,1.36969707e-03,1.36081807e-03,1.35192566e-03,1.34301992e-03,1.33410094e-03,1.32516880e-03,1.31622360e-03,1.30726542e-03,1.29829435e-03,1.28931048e-03,1.28031390e-03,1.27130469e-03,1.26228295e-03,1.25324877e-03,1.24420222e-03,1.23514341e-03,1.22607243e-03,1.21698935e-03,1.20789427e-03,1.19878729e-03,1.18966848e-03,1.18053794e-03,1.17139577e-03,1.16224204e-03,1.15307686e-03,1.14390031e-03,1.13471247e-03,1.12551345e-03,1.11630334e-03,1.10708221e-03,1.09785017e-03,1.08860731e-03,1.07935371e-03,1.07008947e-03,1.06081468e-03,1.05152943e-03,1.04223382e-03,1.03292792e-03,1.02361184e-03,1.01428567e-03,1.00494950e-03,9.95603424e-04,9.86247528e-04,9.76881908e-04,9.67506657e-04,9.58121866e-04,9.48727628e-04,9.39324035e-04,9.29911182e-04,9.20489159e-04,9.11058061e-04,9.01617980e-04,8.92169010e-04,8.82711243e-04,8.73244772e-04,8.63769692e-04,8.54286095e-04,8.44794075e-04,8.35293726e-04,8.25785140e-04,8.16268413e-04,8.06743638e-04,7.97210908e-04,7.87670318e-04,7.78121962e-04,7.68565934e-04,7.59002327e-04,7.49431238e-04,7.39852759e-04,7.30266985e-04,7.20674011e-04,7.11073932e-04,7.01466841e-04,6.91852834e-04,6.82232006e-04,6.72604451e-04,6.62970265e-04,6.53329541e-04,6.43682376e-04,6.34028865e-04,6.24369102e-04,6.14703183e-04,6.05031203e-04,5.95353258e-04,5.85669443e-04,5.75979853e-04,5.66284584e-04,5.56583732e-04,5.46877392e-04,5.37165660e-04,5.27448631e-04,5.17726402e-04,5.07999069e-04,4.98266727e-04,4.88529472e-04,4.78787400e-04,4.69040607e-04,4.59289190e-04,4.49533245e-04,4.39772867e-04,4.30008153e-04,4.20239199e-04,4.10466102e-04,4.00688958e-04,3.90907863e-04,3.81122914e-04,3.71334207e-04,3.61541839e-04,3.51745906e-04,3.41946505e-04,3.32143732e-04,3.22337685e-04,3.12528459e-04,3.02716152e-04,2.92900861e-04,2.83082681e-04,2.73261711e-04,2.63438046e-04,2.53611783e-04,2.43783020e-04,2.33951854e-04,2.24118381e-04,2.14282698e-04,2.04444902e-04,1.94605091e-04,1.84763361e-04,1.74919809e-04,1.65074533e-04,1.55227629e-04,1.45379195e-04,1.35529328e-04,1.25678125e-04,1.15825683e-04,1.05972100e-04,9.61174735e-05,8.62619013e-05,7.64054821e-05,6.65483159e-05,5.66905065e-05,4.68321671e-05,3.69734420e-05,2.71146066e-05,1.72567698e-05,7.41333842e-06};
	
	//double gauss_x[100] = {0.99971373,0.99849195,0.99629513,0.99312494,0.9889844,0.98387754,0.97780936,0.97078578,0.96281365,0.95390078,0.94405587,0.93328854,0.9216093,0.90902957,0.89556164,0.88121868,0.86601469,0.84996453,0.83308388,0.81538924,0.79689789,0.77762791,0.75759812,0.73682809,0.71533812,0.6931492,0.67028302,0.64676191,0.62260886,0.59784747,0.57250193,0.54659701,0.52015802,0.49321079,0.46578165,0.4378974,0.40958529,0.38087298,0.35178853,0.32236034,0.29261719,0.26258812,0.23230248,0.20178986,0.17108008,0.14020314,0.1091892,0.07806858,0.04687168,0.01562898,-0.01562898,-0.04687168,-0.07806858,-0.1091892,-0.14020314,-0.17108008,-0.20178986,-0.23230248,-0.26258812,-0.29261719,-0.32236034,-0.35178853,-0.38087298,-0.40958529,-0.4378974,-0.46578165,-0.49321079,-0.52015802,-0.54659701,-0.57250193,-0.59784747,-0.62260886,-0.64676191,-0.67028302,-0.6931492,-0.71533812,-0.73682809,-0.75759812,-0.77762791,-0.79689789,-0.81538924,-0.83308388,-0.84996453,-0.86601469,-0.88121868,-0.89556164,-0.90902957,-0.9216093,-0.93328854,-0.94405587,-0.95390078,-0.96281365,-0.97078578,-0.97780936,-0.98387754,-0.9889844,-0.99312494,-0.99629513,-0.99849195,-0.99971373};
	//double gauss_w[100] = {0.00073463,0.00170939,0.00268393,0.00365596,0.00462445,0.00558843,0.00654695,0.00749907,0.00844387,0.00938042,0.0103078,0.01122511,0.01213146,0.01302595,0.01390771,0.01477588,0.01562962,0.01646809,0.01729046,0.01809594,0.01888374,0.01965309,0.02040323,0.02113344,0.021843,0.02253122,0.02319742,0.02384096,0.0244612,0.02505754,0.0256294,0.02617622,0.02669746,0.02719261,0.0276612,0.02810276,0.02851685,0.02890309,0.02926108,0.02959049,0.02989098,0.03016227,0.03040408,0.03061619,0.03079838,0.03095048,0.03107234,0.03116384,0.03122488,0.03125542,0.03125542,0.03122488,0.03116384,0.03107234,0.03095048,0.03079838,0.03061619,0.03040408,0.03016227,0.02989098,0.02959049,0.02926108,0.02890309,0.02851685,0.02810276,0.0276612,0.02719261,0.02669746,0.02617622,0.0256294,0.02505754,0.0244612,0.02384096,0.02319742,0.02253122,0.021843,0.02113344,0.02040323,0.01965309,0.01888374,0.01809594,0.01729046,0.01646809,0.01562962,0.01477588,0.01390771,0.01302595,0.01213146,0.01122511,0.0103078,0.00938042,0.00844387,0.00749907,0.00654695,0.00558843,0.00462445,0.00365596,0.00268393,0.00170939,0.00073463};

	double T_half = T/2.;

	gsl_matrix* A_int = gsl_matrix_calloc(n,n);
	gsl_matrix* A_val = gsl_matrix_calloc(n,n);

	for (int i = 0; i < N; ++i)
	{
		A(T_half*(gauss_x[i]+1.),A_val,params);
		gsl_matrix_scale(A_val,T_half*gauss_w[i]);
		gsl_matrix_add(A_int,A_val);
	}
	// Computation of A_int is done. Now on to find eigenvalues.
	gsl_matrix_free(A_val);

	gsl_vector_complex* eigenvals = gsl_vector_complex_alloc(n);

	gsl_eigen_nonsymm_workspace* w = gsl_eigen_nonsymm_alloc(n);

	int n_eigenvals_evaluated = n;
	
	if(gsl_eigen_nonsymm(A_int,eigenvals,w))
	{
		n_eigenvals_evaluated = w->n_evals;
	}

	double mult_max_real = -HUGE_VAL;
	gsl_complex mult_max;
	double ev_test;
	for (int i = 0; i < n_eigenvals_evaluated; ++i)
	{
		ev_test = GSL_REAL(gsl_vector_complex_get(eigenvals,i));
		if (mult_max_real < ev_test)
		{
			mult_max_real = ev_test;
			mult_max = gsl_vector_complex_get(eigenvals,i);
		}
		printf("%lf\n",ev_test);
	}

	if (largest_multiplier != NULL)
	{
		*largest_multiplier = gsl_complex_exp(mult_max);
	}
	if (largest_multiplier_abs != NULL)
	{
		*largest_multiplier_abs = exp(mult_max_real);
	}

	for (int i = 0; i < n; ++i)
	{
		for (int j = 0; j < n; ++j)
		{
			printf("%lf ",gsl_matrix_get(A_int,i,j));
		}
		printf("\n");
	}

	gsl_eigen_nonsymm_free(w);
	gsl_vector_complex_free(eigenvals);	
	gsl_matrix_free(A_int);

	if (mult_max_real > ERR_EIGEN_TOL)
	{
		return 1;
	}
	else if (mult_max_real < (-ERR_EIGEN_TOL))
	{
		if (n_eigenvals_evaluated < n)
		{
			return 2;
		}
		return -1;
	}
	else
	{
		return 0;
	}
}

void floquet_get_stability_array_real_double_param_goodfunc(int n, void (*A)(double, gsl_matrix*, void*), double T, double* start, double* end, int* nstep, int** stability, gsl_complex** largest_multiplier, double** largest_multiplier_abs)
{
	gsl_complex** mult_temp;
	double** mult_abs_temp;

	if (largest_multiplier)
	{
		mult_temp = largest_multiplier;
	}
	else
	{
		mult_temp = (gsl_complex**) malloc(nstep[0]*sizeof(gsl_complex*));
		for (int i = 0; i < nstep[0]; ++i)
		{
			mult_temp[i] = (gsl_complex*) malloc(nstep[1]*sizeof(gsl_complex));
		}
	}

	if (largest_multiplier_abs)
	{
		mult_abs_temp = largest_multiplier_abs;
	}
	else
	{
		mult_abs_temp = (double**) malloc(nstep[0]*sizeof(double*));
		for (int i = 0; i < nstep[0]; ++i)
		{
			mult_abs_temp[i] = (double*) malloc(nstep[1]*sizeof(double));
		}
	}

	double step[2] = {(end[0]-start[0])/(nstep[0]-1), (end[1]-start[1])/(nstep[1]-1)};
	#pragma omp parallel for collapse(2)
	for (int i = 0; i < nstep[0]; ++i)
	{
		for (int j = 0; j < nstep[1]; ++j)
		{
			printf("Start %d %d\n",i,j);
			double param[2] = {start[0] + step[0]*i, start[1] + step[1]*j };
			stability[i][j] = floquet_get_stability_reals_goodfunc(n,A,param,T,&mult_temp[i][j],&mult_abs_temp[i][j]);
			printf("End %d %d\n",i,j);
		}
	}

	if(!largest_multiplier)
	{
		for (int i = 0; i < nstep[0]; ++i)
		{
			free(mult_temp[i]);
		}
		free(mult_temp);
	}

	if(!largest_multiplier_abs)
	{
		for (int i = 0; i < nstep[0]; ++i)
		{
			free(mult_abs_temp[i]);
		}
		free(mult_abs_temp);
	}
}